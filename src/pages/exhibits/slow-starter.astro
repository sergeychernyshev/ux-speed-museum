---
import ExhibitLayout from '../../layouts/ExhibitLayout.astro';
import ExhibitDescription from '../../components/ExhibitDescription.astro';
import PerformanceController from '../../components/PerformanceController.astro';
import ProductPageMock from '../../components/ProductPageMock.astro';

const title = 'The Slow Starter';
const description =
  'Experience how First Contentful Paint (FCP) impacts the initial perception of speed. The "Optimized" version renders at the 5th percentile (P5) baseline of 500ms, while the "Throttled" version adds your chosen delay. Observe how the assembly of the page feels as the rendering delay increases.';
---

<ExhibitLayout title={title}>
  <ExhibitDescription description={description} />

  <div class="exhibit-stage">
    <div class="comparison-container" id="comparison-stage">
      <div class="comparison-panel">
        <span class="panel-label">Optimized (500ms)</span>
        <div class="viewport" id="optimized-viewport">
          <ProductPageMock id="optimized-page" />
        </div>
      </div>

      <div class="comparison-panel">
        <span class="panel-label">Throttled (500ms + Delay)</span>
        <div class="viewport" id="throttled-viewport">
          <ProductPageMock id="throttled-page" />
        </div>
      </div>
    </div>

    <div class="controls-overlay">
      <PerformanceController
        min={0}
        max={5000}
        step={100}
        defaultValue={2000}
        label="Time to start rendering"
        unit="ms"
      />
    </div>
  </div>

  <style>
    .exhibit-stage {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      align-items: center;
    }

    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      width: 100%;
      min-height: 600px;
    }

    @media (max-width: 1024px) {
      .comparison-container {
        grid-template-columns: 1fr;
      }
    }

    .comparison-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }

    .panel-label {
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: var(--muted-text);
    }

    .viewport {
      width: 100%;
      background: var(--sidebar-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 1rem;
      position: relative;
      min-height: 500px;
    }

    .controls-overlay {
      position: sticky;
      bottom: 2rem;
      z-index: 100;
    }
  </style>

  <script>
    const OPTIMIZED_BASE = 500;
    let additionalDelay = 2000;
    let timers: number[] = [];

    const stage = document.getElementById('comparison-stage');
    const optPage = document.getElementById('optimized-page');
    const thrPage = document.getElementById('throttled-page');

    function clearTimers() {
      timers.forEach((t) => clearTimeout(t));
      timers = [];
    }

    function resetViews() {
      clearTimers();
      stage?.classList.add('scrubbing');

      [optPage, thrPage].forEach((page) => {
        if (!page) return;
        page.classList.remove('visible');
        page.querySelectorAll('.painted').forEach((el) => {
          el.classList.remove('painted');
        });
      });
    }

    function startRendering() {
      stage?.classList.remove('scrubbing');

      // Start Optimized sequence
      runSequence(optPage, OPTIMIZED_BASE);

      // Start Throttled sequence
      runSequence(thrPage, OPTIMIZED_BASE + additionalDelay);
    }

    function runSequence(page: HTMLElement | null, startDelay: number) {
      if (!page) return;

      const steps = [
        { selector: '.product-page-mock', class: 'visible', delay: 0 },
        { selector: '.mock-nav', class: 'painted', delay: 100 },
        { selector: '.mock-hero', class: 'painted', delay: 200 },
        { selector: '.product-image', class: 'painted', delay: 400 },
        { selector: '.product-title', class: 'painted', delay: 100 },
        { selector: '.product-price', class: 'painted', delay: 50 },
        { selector: '.buy-button', class: 'painted', delay: 100 },
        { selector: '.mock-description', class: 'painted', delay: 300 },
        { selector: '.desc-text', class: 'painted', delay: 100 },
        { selector: '.spec-list', class: 'painted', delay: 100 },
        { selector: '.mock-footer', class: 'painted', delay: 200 },
      ];

      let accumulatedDelay = startDelay;

      steps.forEach((step) => {
        accumulatedDelay += step.delay;
        const timer = window.setTimeout(() => {
          if (step.selector === '.product-page-mock') {
            page.classList.add(step.class);
          } else {
            page.querySelector(step.selector)?.classList.add(step.class);
          }
        }, accumulatedDelay);

        timers.push(timer);
      });
    }

    // Listen for scrubber updates
    window.addEventListener('performance-update', (e: any) => {
      resetViews();
      additionalDelay = e.detail.value;
    });

    window.addEventListener('performance-update-end', () => {
      startRendering();
    });

    // Initial run
    startRendering();
  </script>
</ExhibitLayout>
