---
import ExhibitLayout from '../../layouts/ExhibitLayout.astro';
import ExhibitDescription from '../../components/ExhibitDescription.astro';
import PerformanceController from '../../components/PerformanceController.astro';
import ProductCard from '../../components/ProductCard.astro';

const title = 'The Slow Starter';
const description =
  'Experience how First Contentful Paint (FCP) impacts the initial perception of speed. The "Optimized" version renders at the 5th percentile (P5) baseline of 500ms, while the "Throttled" version adds your chosen delay. Observe how the assembly of the page feels as the rendering delay increases.';
---

<ExhibitLayout title={title}>
  <ExhibitDescription description={description} />

  <div class="exhibit-stage">
    <div class="comparison-container" id="comparison-stage">
      <div class="comparison-panel">
        <span class="panel-label">Optimized (500ms)</span>
        <div class="viewport" id="optimized-viewport">
          <ProductCard id="optimized-card" />
        </div>
      </div>

      <div class="comparison-panel">
        <span class="panel-label">Throttled (500ms + Delay)</span>
        <div class="viewport" id="throttled-viewport">
          <ProductCard id="throttled-card" />
        </div>
      </div>
    </div>

    <div class="controls-overlay">
      <PerformanceController
        min={0}
        max={5000}
        step={100}
        defaultValue={2000}
        label="Additional Rendering Delay"
        unit="ms"
      />
    </div>
  </div>

  <style>
    .exhibit-stage {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      align-items: center;
    }

    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      width: 100%;
      min-height: 500px;
    }

    @media (max-width: 768px) {
      .comparison-container {
        grid-template-columns: 1fr;
      }
    }

    .comparison-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }

    .panel-label {
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: var(--muted-text);
    }

    .viewport {
      width: 100%;
      aspect-ratio: 4/5;
      background: var(--sidebar-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      position: relative;
      transition: background-color 0.3s;
    }

    :global(.scrubbing) .viewport {
      background-color: var(--border-color);
    }

    .controls-overlay {
      position: sticky;
      bottom: 2rem;
      z-index: 100;
    }
  </style>

  <script>
    const OPTIMIZED_BASE = 500;
    let additionalDelay = 2000;
    let timers: number[] = [];

    const stage = document.getElementById('comparison-stage');
    const optCard = document.getElementById('optimized-card');
    const thrCard = document.getElementById('throttled-card');

    function clearTimers() {
      timers.forEach((t) => clearTimeout(t));
      timers = [];
    }

    function resetViews() {
      clearTimers();
      stage?.classList.add('scrubbing');

      [optCard, thrCard].forEach((card) => {
        if (!card) return;
        card.classList.remove('visible');
        card.querySelectorAll('.painted').forEach((el) => {
          el.classList.remove('painted');
        });
      });
    }

    function startRendering() {
      stage?.classList.remove('scrubbing');

      // Start Optimized sequence
      runSequence(optCard, OPTIMIZED_BASE);

      // Start Throttled sequence
      runSequence(thrCard, OPTIMIZED_BASE + additionalDelay);
    }

    function runSequence(card: HTMLElement | null, startDelay: number) {
      if (!card) return;

      const elements = [
        { selector: '.product-card', class: 'visible' },
        { selector: '.product-image', class: 'painted' },
        { selector: '.product-title', class: 'painted' },
        { selector: '.product-price', class: 'painted' },
        { selector: '.buy-button', class: 'painted' },
      ];

      let currentDelay = startDelay;

      elements.forEach((step, index) => {
        const timer = window.setTimeout(() => {
          if (step.selector === '.product-card') {
            card.classList.add('visible');
          } else {
            card.querySelector(step.selector)?.classList.add(step.class);
          }
        }, currentDelay);

        timers.push(timer);
        // Stagger elements by 200ms
        currentDelay += 200;
      });
    }

    // Listen for scrubber updates
    window.addEventListener('performance-update', (e: any) => {
      resetViews();
      additionalDelay = e.detail.value;
    });

    window.addEventListener('performance-update-end', () => {
      startRendering();
    });

    // Initial run
    startRendering();
  </script>
</ExhibitLayout>
