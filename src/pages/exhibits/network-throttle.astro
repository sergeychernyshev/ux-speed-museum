---
import ExhibitLayout from '../../layouts/ExhibitLayout.astro';
import ExhibitDescription from '../../components/ExhibitDescription.astro';
import PerformanceController from '../../components/PerformanceController.astro';

const title = 'Network Throttle';
const description =
  'Have you ever felt the "wait" of a slow connection? This exhibit simulates how different network conditionsâ€”from Fiber to 2Gâ€”impact the Largest Contentful Paint (LCP) and the overall page assembly. Watch as resources load sequentially (the "Waterfall") and experience how bandwidth and latency dictate the rhythm of the web.';
---

<ExhibitLayout title={title} image="/slow-starter.webp">
  <ExhibitDescription
    slot="description"
    title={title}
    description={description}
  />

  <div class="exhibit-stage">
    <div class="comparison-container" id="comparison-stage">
      <!-- Throttled Side (Left) -->
      <div class="comparison-panel">
        <div class="experience-block">
          <div class="metric-header">
            <div class="metric-display" id="throttled-lcp">LCP: -.--s</div>
            <div class="panel-info">
              <span class="panel-label" id="throttled-label">Slow 4G</span>
              <p class="panel-note" id="throttled-note">
                Simulating 1.6 Mbps / 150ms RTT.
              </p>
            </div>
          </div>
          <div class="viewport" id="throttled-viewport">
            <div class="waterfall-container" id="throttled-waterfall">
              <!-- Waterfall visualization will be injected here -->
            </div>
            <div class="feed-container" id="throttled-feed">
              <!-- Feed items will be injected here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Fiber Side (Right) -->
      <div class="comparison-panel">
        <div class="experience-block">
          <div class="metric-header">
            <div class="panel-info">
              <span class="panel-label">Fiber</span>
              <p class="panel-note">Unthrottled (Instant).</p>
            </div>
            <div class="metric-display" id="fiber-lcp">LCP: -.--s</div>
          </div>
          <div class="viewport" id="fiber-viewport">
            <div class="feed-container" id="fiber-feed">
              <!-- Feed items will be injected here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="controls-overlay">
      <PerformanceController
        min={0}
        max={3}
        step={1}
        defaultValue={2}
        label="Network Profile"
        id="network-scrubber"
        list="network-snaps"
        showReplay={true}
      />
      <datalist id="network-snaps">
        <option value="0" label="2G"></option>
        <option value="1" label="3G"></option>
        <option value="2" label="Slow 4G"></option>
        <option value="3" label="Fiber"></option>
      </datalist>
    </div>
  </div>

  <style>
    .exhibit-stage {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      align-items: center;
    }

    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      width: 100%;
      min-height: 600px;
    }

    .comparison-panel:first-child {
      order: -1;
    }

    @media (max-width: 768px) {
      .comparison-container {
        grid-template-columns: 1fr;
      }
    }

    .comparison-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      width: 100%;
    }

    .metric-header {
      display: flex;
      align-items: flex-end;
      width: 100%;
      margin-bottom: 0;
    }

    .panel-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding-bottom: 0.5rem;
      align-items: center;
      text-align: center;
    }

    .panel-label {
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: var(--muted-text);
    }

    .panel-note {
      font-size: 0.7rem;
      color: var(--muted-text);
      font-style: italic;
      height: 1rem;
    }

    .experience-block {
      display: flex;
      flex-direction: column;
      width: 100%;
      align-items: flex-start;
    }

    .metric-display {
      font-family: monospace;
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--accent-color);
      background: var(--card-bg);
      padding: 0.25rem 0.75rem;
      min-width: 10rem;
      font-variant-numeric: tabular-nums;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-color);
      border-bottom: none;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      margin-bottom: 0;
      position: relative;
      z-index: 5;
    }

    .viewport {
      width: 100%;
      height: 35rem;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      border-top-left-radius: 0;
      padding: 0;
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* Feed Styling */
    .feed-container {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .feed-item {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-color);
      opacity: 0;
      transform: translateY(10px);
      transition:
        opacity 0.3s,
        transform 0.3s;
    }

    .feed-item.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--sidebar-bg);
      overflow: hidden;
      position: relative;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
    }

    .avatar.loaded img {
      opacity: 1;
    }

    .user-info .name {
      font-weight: bold;
      font-size: 0.9rem;
      display: block;
    }

    .user-info .handle {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .post-content {
      font-size: 0.9rem;
      line-height: 1.4;
      margin-bottom: 0.75rem;
    }

    .post-image {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: var(--sidebar-bg);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.75rem;
      position: relative;
    }

    .post-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      clip-path: inset(0 0 100% 0);
    }

    .post-image.loaded img {
      clip-path: inset(0 0 0 0);
    }

    /* Stutter animation for images */
    .post-image.loading img {
      animation: stutter-load 2s steps(1, end) forwards;
    }

    @keyframes stutter-load {
      0% { clip-path: inset(0 0 100% 0); }
      15% { clip-path: inset(0 0 95% 0); }
      25% { clip-path: inset(0 0 85% 0); }
      40% { clip-path: inset(0 0 50% 0); }
      65% { clip-path: inset(0 0 45% 0); }
      85% { clip-path: inset(0 0 10% 0); }
      100% { clip-path: inset(0 0 0% 0); }
    }

    .image-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 0.5rem;
    }

    .progress-bar-container {
      width: 60%;
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: var(--accent-color);
      border-radius: 2px;
      transition: width 0.1s linear;
    }

    .download-label {
      font-size: 0.6rem;
      color: var(--muted-text);
      font-family: monospace;
    }

    .post-actions {
      display: flex;
      gap: 1rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
    }

    .action {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    /* Waterfall Styling */
    .waterfall-container {
      background: var(--sidebar-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem;
      font-family: monospace;
      font-size: 0.65rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
      position: sticky;
      top: 0;
      z-index: 20;
      max-height: 150px;
      overflow-y: auto;
    }

    .waterfall-row {
      display: grid;
      grid-template-columns: 80px 1fr;
      align-items: center;
      gap: 0.5rem;
    }

    .resource-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--muted-text);
    }

    .timeline-track {
      height: 6px;
      background: rgba(0, 0, 0, 0.05);
      position: relative;
      border-radius: 3px;
    }

    .resource-bar {
      position: absolute;
      height: 100%;
      background: var(--accent-color);
      border-radius: 3px;
      min-width: 2px;
    }

    .resource-bar.pending {
      background: var(--border-color);
      opacity: 0.5;
    }

    .controls-overlay {
      position: sticky;
      bottom: 2rem;
      z-index: 100;
    }

    .lcp-highlight {
      outline: 2px solid var(--accent-color);
      outline-offset: -2px;
    }

    :global(.paused) .post-image.loading img {
      animation-play-state: paused !important;
    }

    :global(.scrubbing) .feed-item {
      opacity: 0 !important;
    }
  </style>

  <script>
    type Resource = {
      id: string;
      name: string;
      sizeKB: number;
      type: 'html' | 'js' | 'css' | 'img' | 'json';
      lcp?: boolean;
    };

    type NetworkProfile = {
      label: string;
      bandwidth: number; // kbps
      latency: number; // ms
    };

    const PROFILES: Record<string, NetworkProfile> = {
      '0': { label: '2G', bandwidth: 50, latency: 800 },
      '1': { label: '3G', bandwidth: 750, latency: 300 },
      '2': { label: 'Slow 4G', bandwidth: 1600, latency: 150 },
      '3': { label: 'Fiber', bandwidth: 100000, latency: 5 },
    };

    const RESOURCES: Resource[] = [
      { id: 'json', name: 'feed.json', sizeKB: 5, type: 'json' },
      { id: 'avatar1', name: 'avatar1.png', sizeKB: 4, type: 'img' },
      { id: 'img1', name: 'photo1.jpg', sizeKB: 120, type: 'img' },
      { id: 'avatar2', name: 'avatar2.png', sizeKB: 5, type: 'img' },
      { id: 'img2', name: 'photo2.jpg', sizeKB: 450, type: 'img', lcp: true },
      { id: 'avatar3', name: 'avatar3.png', sizeKB: 4, type: 'img' },
      { id: 'img3', name: 'photo3.jpg', sizeKB: 180, type: 'img' },
    ];

    const POSTS_DATA = [
      {
        id: 1,
        author: 'Sarah Drasner',
        handle: '@sarah_edo',
        content:
          'I love how CSS lets you express creativity through code. SVG animations are my favorite! âœ¨',
        avatar: '/slow-starter.webp',
        image: '/shifty-physics.avif',
        imageId: 'img1',
        avatarId: 'avatar1',
      },
      {
        id: 2,
        author: 'Alex Russell',
        handle: '@slightlylate',
        content:
          'Web performance is about more than just fast networks. It is about how the browser handles resources on real-world devices. ðŸ“±',
        avatar: '/logo.svg',
        image: '/chronos.avif',
        imageId: 'img2',
        avatarId: 'avatar2',
      },
      {
        id: 3,
        author: 'Addy Osmani',
        handle: '@addyosmani',
        content:
          'Loading images is a fine balance. Always try to reserve space to avoid layout shifts! ðŸš€',
        avatar: '/favicon.png',
        image: '/shift-the-ad.avif',
        imageId: 'img3',
        avatarId: 'avatar3',
      },
    ];

    let currentProfile = PROFILES['2'];
    let timers: number[] = [];
    let startTime = 0;
    let isPaused = false;
    let pauseStartTime = 0;
    let totalPausedTime = 0;
    let activeSimulation = false;

    const throttledFeed = document.getElementById('throttled-feed');
    const fiberFeed = document.getElementById('fiber-feed');
    const throttledWaterfall = document.getElementById('throttled-waterfall');
    const throttledLcpEl = document.getElementById('throttled-lcp');
    const fiberLcpEl = document.getElementById('fiber-lcp');
    const throttledLabel = document.getElementById('throttled-label');
    const throttledNote = document.getElementById('throttled-note');
    const stage = document.getElementById('comparison-stage');

    function getLCPClass(seconds: number) {
      if (seconds <= 2.5) return 'fcp-good';
      if (seconds <= 4.0) return 'fcp-needs-improvement';
      return 'fcp-poor';
    }

    function createFeedItem(post: any, side: 'throttled' | 'fiber') {
      const item = document.createElement('div');
      item.className = 'feed-item';
      item.id = `${side}-post-${post.id}`;
      item.innerHTML = `
        <div class="post-header">
          <div class="avatar" id="${side}-avatar-container-${post.id}">
            <img src="${post.avatar}" alt="${post.author}" />
          </div>
          <div class="user-info">
            <span class="name">${post.author}</span>
            <span class="handle">${post.handle}</span>
          </div>
        </div>
        <div class="post-content">${post.content}</div>
        <div class="post-image" id="${side}-img-container-${post.id}">
          <div class="image-placeholder" id="${side}-placeholder-${post.id}">
            <div class="progress-bar-container">
              <div class="progress-bar" id="${side}-progress-${post.id}"></div>
            </div>
            <span class="download-label" id="${side}-label-${post.id}">Queued...</span>
          </div>
          <img src="${post.image}" alt="Post image" id="${side}-img-${post.id}" />
        </div>
        <div class="post-actions">
          <span class="action">Like</span>
          <span class="action">Retweet</span>
          <span class="action">Share</span>
        </div>
      `;
      return item;
    }

    function createWaterfallRow(resource: Resource) {
      const row = document.createElement('div');
      row.className = 'waterfall-row';
      row.innerHTML = `
        <div class="resource-name" title="${resource.name}">${resource.name}</div>
        <div class="timeline-track">
          <div class="resource-bar pending" id="wf-${resource.id}"></div>
        </div>
      `;
      return row;
    }

    function resetViews() {
      timers.forEach(clearTimeout);
      timers = [];
      startTime = 0;
      isPaused = false;
      pauseStartTime = 0;
      totalPausedTime = 0;
      activeSimulation = false;
      stage?.classList.add('scrubbing');
      stage?.classList.remove('paused');

      if (throttledFeed) throttledFeed.innerHTML = '';
      if (fiberFeed) fiberFeed.innerHTML = '';
      if (throttledWaterfall) throttledWaterfall.innerHTML = '';
      if (throttledLcpEl) throttledLcpEl.innerHTML = 'LCP: -.--s';
      if (fiberLcpEl) fiberLcpEl.innerHTML = 'LCP: -.--s';
    }

    async function runSimulation() {
      resetViews();
      stage?.classList.remove('scrubbing');
      activeSimulation = true;
      startTime = performance.now();

      // Setup Waterfall
      RESOURCES.forEach((res) => {
        throttledWaterfall?.appendChild(createWaterfallRow(res));
      });

      // Setup Feeds
      POSTS_DATA.forEach((post) => {
        throttledFeed?.appendChild(createFeedItem(post, 'throttled'));
        fiberFeed?.appendChild(createFeedItem(post, 'fiber'));
      });

      // Run simulations
      runSide('throttled', currentProfile);
      runSide('fiber', PROFILES['3']);
    }

    async function runSide(side: 'throttled' | 'fiber', profile: NetworkProfile) {
      let currentTimeOffset = 0;
      const isThrottled = side === 'throttled';

      for (const res of RESOURCES) {
        if (!activeSimulation) break;

        const duration = profile.latency + (res.sizeKB / (profile.bandwidth / 8)) * 1000;
        const start = currentTimeOffset;

        await simulateResource(res, start, duration, side);
        currentTimeOffset += duration;
      }

      if (isThrottled && activeSimulation) {
        window.dispatchEvent(
          new CustomEvent('performance-update-end', {
            detail: { value: currentTimeOffset, source: 'simulation' },
          })
        );
      }
    }

    function simulateResource(
      res: Resource,
      start: number,
      duration: number,
      side: 'throttled' | 'fiber'
    ) {
      return new Promise<void>((resolve) => {
        const checkPause = () => {
          if (isPaused) {
            setTimeout(checkPause, 100);
            return;
          }

          const timer = window.setTimeout(() => {
            handleResourceComplete(res, side, start, duration);
            resolve();
          }, duration);
          timers.push(timer);
        };

        // For Waterfall visualization
        if (side === 'throttled') {
          animateWaterfall(res.id, start, duration);
        }

        checkPause();
      });
    }

    function animateWaterfall(resId: string, start: number, duration: number) {
      const bar = document.getElementById(`wf-${resId}`);
      if (!bar) return;

      const totalSimulationDuration = 10000; // Max visual scale 10s
      const left = (start / totalSimulationDuration) * 100;
      const width = (duration / totalSimulationDuration) * 100;
      bar.style.left = `${left}%`;
      bar.style.width = `${width}%`;
    }

    function handleResourceComplete(
      res: Resource,
      side: 'throttled' | 'fiber',
      start: number,
      duration: number
    ) {
      const isThrottled = side === 'throttled';

      if (res.type === 'json') {
        document.querySelectorAll(`#${side}-feed .feed-item`).forEach((item) => {
          item.classList.add('visible');
        });
      } else if (res.id.startsWith('avatar')) {
        const postId = res.id.replace('avatar', '');
        document.getElementById(`${side}-avatar-container-${postId}`)?.classList.add('loaded');
      } else if (res.id.startsWith('img')) {
        const postId = res.id.replace('img', '');
        const container = document.getElementById(`${side}-img-container-${postId}`);
        const placeholder = document.getElementById(`${side}-placeholder-${postId}`);
        if (container) {
          container.classList.add('loaded');
          // Add loading class for stutter animation ONLY on throttled side
          if (isThrottled) container.classList.add('loading');
        }
        if (placeholder) placeholder.style.display = 'none';

        if (res.lcp) {
          const now = (performance.now() - startTime - totalPausedTime) / 1000;
          const lcpEl = isThrottled ? throttledLcpEl : fiberLcpEl;
          if (lcpEl) {
            lcpEl.innerHTML = `LCP: <span class="${getLCPClass(now)}">${now.toFixed(2)}s</span>`;
          }
          container?.classList.add('lcp-highlight');
        }
      }

      if (isThrottled) {
        const bar = document.getElementById(`wf-${res.id}`);
        if (bar) bar.classList.remove('pending');
      }
    }

    window.addEventListener('performance-update', (e: any) => {
      const val = e.detail.value;
      currentProfile = PROFILES[val.toString()];

      if (throttledLabel) throttledLabel.textContent = currentProfile.label;
      if (throttledNote) {
        const bandwidthDisplay =
          currentProfile.bandwidth >= 1000
            ? `${(currentProfile.bandwidth / 1000).toFixed(1)} Mbps`
            : `${currentProfile.bandwidth} kbps`;
        throttledNote.textContent = `Simulating ${bandwidthDisplay} / ${currentProfile.latency}ms RTT.`;
      }

      resetViews();
    });

    window.addEventListener('performance-update-end', (e: any) => {
      if (e.detail?.source === 'scrubber') {
        runSimulation();
      }
    });

    window.addEventListener('performance-replay', () => {
      runSimulation();
    });

    window.addEventListener('performance-toggle-pause', (e: any) => {
      isPaused = e.detail.isPaused;
      if (isPaused) {
        pauseStartTime = performance.now();
        stage?.classList.add('paused');
      } else {
        totalPausedTime += performance.now() - pauseStartTime;
        stage?.classList.remove('paused');
      }
    });

    // Initial run
    setTimeout(runSimulation, 500);
  </script>
</ExhibitLayout>
