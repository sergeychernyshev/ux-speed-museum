---
import '../styles/global.css';

interface Props {
  title: string;
  showShield?: boolean;
}

const { title, showShield = true } = Astro.props;

// SSR Preference reading
const audioEnabled =
  Astro.cookies.get('exhibit-audio-enabled')?.value !== 'false';
const animationsEnabled =
  Astro.cookies.get('exhibit-animations-enabled')?.value !== 'false';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | UX Speed Museum</title>

    <style>
      .layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        grid-template-rows: auto 1fr;
        min-height: 100vh;
      }

      @media (max-width: 768px) {
        .layout {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto 1fr;
        }
      }

      header {
        grid-column: 1 / -1;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--header-bg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        flex-wrap: wrap;
        gap: 1rem;
      }

      header h1 {
        font-size: 1.5rem;
        margin-bottom: 0;
      }

      header h1 a {
        text-decoration: none;
        color: inherit;
      }

      .menu-toggle {
        display: none;
        background: none;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.5rem;
        cursor: pointer;
        color: var(--text-color);
        font-size: 1.25rem;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        z-index: 110;
      }

      nav {
        background: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        padding: 1.5rem;
        transition: transform 0.3s ease-in-out;
      }

      @media (max-width: 768px) {
        .menu-toggle {
          display: flex;
        }

        nav {
          position: fixed;
          top: 0;
          left: 0;
          width: 250px;
          height: 100vh;
          z-index: 90;
          transform: translateX(-100%);
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
          border-right: 1px solid var(--border-color);
          padding-top: 5rem; /* Space for header */
        }

        nav.active {
          transform: translateX(0);
        }

        .layout.menu-open::after {
          content: '';
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.5);
          z-index: 80;
        }
      }

      main {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
        position: relative;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
      }

      @media (max-width: 480px) {
        main {
          padding: 1rem;
        }
      }

      .preparation-shield {
        width: 100%;
        padding: 2rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition:
          opacity 0.5s ease-out,
          visibility 0.5s;
        margin-bottom: 2rem;
      }

      .preparation-shield.ready {
        display: none;
      }

      .exhibit-content {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-in;
      }

      .exhibit-content.ready {
        opacity: 1;
        visibility: visible;
      }

      .shield-content {
        text-align: center;
        width: 100%;
        max-width: 300px;
      }

      .loading-progress {
        height: 4px;
        width: 100%;
        background: var(--border-color);
        border-radius: 2px;
        margin-bottom: 1rem;
        overflow: hidden;
        position: relative;
      }

      .loading-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0%;
        background: var(--accent-color);
        transition: width 0.3s ease-out;
      }

      /* No animation unless shield is shown */
      .preparation-shield.ready .loading-bar {
        animation: none;
      }
    </style>
  </head>
  <body>
    <div class="layout" id="app-layout">
      <header>
        <button class="menu-toggle" id="menu-toggle" aria-label="Toggle Menu">
          ☰
        </button>
        <h1><a href="/">UX Speed Museum</a></h1>
        <div class="global-controls">
          <!-- Global controls will go here -->
        </div>
      </header>

      <nav id="sidebar-nav">
        <h3>Exhibits</h3>
        <ul>
          <li>
            <a href="/" data-astro-prefetch> Home </a>
          </li>
          <li>
            <a href="/exhibits/slow-starter" data-astro-prefetch>
              The Slow Starter
            </a>
          </li>
          <!-- Exhibit links will be added here -->
        </ul>
      </nav>

      <main>
        <slot name="description" />

        {
          showShield && (
            <div id="shield" class="preparation-shield">
              <script is:inline>
                {`
                  (function () {
                    if (document.readyState === 'complete') {
                      const s = document.getElementById('shield');
                      if (s) s.style.display = 'none';
                    }
                  })();
                  `}
              </script>
              <div class="shield-content">
                <div class="loading-progress">
                  <div id="loading-bar" class="loading-bar" />
                </div>
                <p>We are preparing your experience...</p>
              </div>
            </div>
          )
        }

        <div
          id="exhibit-content"
          class:list={['exhibit-content', { ready: !showShield }]}
        >
          <slot />
        </div>
      </main>
    </div>

    <script>
      // Menu Toggle Logic
      const menuToggle = document.getElementById('menu-toggle');
      const sidebarNav = document.getElementById('sidebar-nav');
      const appLayout = document.getElementById('app-layout');

      if (menuToggle && sidebarNav && appLayout) {
        menuToggle.addEventListener('click', () => {
          sidebarNav.classList.toggle('active');
          appLayout.classList.toggle('menu-open');
          menuToggle.textContent = sidebarNav.classList.contains('active')
            ? '✕'
            : '☰';
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (
            sidebarNav.classList.contains('active') &&
            !sidebarNav.contains(e.target as Node) &&
            !menuToggle.contains(e.target as Node)
          ) {
            sidebarNav.classList.remove('active');
            appLayout.classList.remove('menu-open');
            menuToggle.textContent = '☰';
          }
        });
      }

      // The Preparation Shield logic
      const shield = document.getElementById('shield');
      const bar = document.getElementById('loading-bar');
      const content = document.getElementById('exhibit-content');

      if (shield && bar && content) {
        const setReady = () => {
          shield.classList.add('ready');
          content.classList.add('ready');
        };

        // If window is already loaded (e.g. from cache or very fast), hide immediately
        if (document.readyState === 'complete') {
          setReady();
        } else {
          // Track resource loading
          const resources = performance.getEntriesByType('resource');
          const totalResources = resources.length || 10; // Fallback estimate
          let loadedResources = 0;

          const updateProgress = () => {
            loadedResources++;
            const progress = Math.min(
              (loadedResources / totalResources) * 100,
              100
            );
            bar.style.width = `${progress}%`;

            if (progress >= 100) {
              setTimeout(() => {
                setReady();
              }, 300);
            }
          };

          // Listen for resource loads
          const observer = new PerformanceObserver((list) => {
            list.getEntries().forEach(() => {
              updateProgress();
            });
          });

          observer.observe({ entryTypes: ['resource'] });

          // Final safety net
          window.addEventListener('load', () => {
            bar.style.width = '100%';
            setTimeout(() => {
              setReady();
              observer.disconnect();
            }, 200);
          });

          // If no new resources after 500ms, assume ready
          setTimeout(() => {
            if (
              loadedResources === 0 &&
              document.readyState === 'interactive'
            ) {
              setReady();
            }
          }, 500);
        }
      }
    </script>
  </body>
</html>
